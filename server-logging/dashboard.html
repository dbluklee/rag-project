<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHEESEADE RAG ë¡œê·¸ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-online { background-color: #00ff88; }
        .status-offline { background-color: #ff4757; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-content {
            padding: 30px;
        }

        .stats-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
            line-height: 1;
        }

        .stat-label {
            color: #6c757d;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .stat-change {
            font-size: 0.85em;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .stat-increase {
            background: #d4edda;
            color: #155724;
        }

        .stat-decrease {
            background: #f8d7da;
            color: #721c24;
        }

        .controls-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 15px;
            align-items: center;
        }

        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .conversations-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .conversations-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px 25px;
            border-bottom: 1px solid #e9ecef;
        }

        .conversations-body {
            max-height: 800px;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 25px;
            border-bottom: 1px solid #f1f3f4;
            transition: all 0.3s ease;
            position: relative;
        }

        .conversation-item:hover {
            background: #f8f9fa;
        }

        .conversation-item:last-child {
            border-bottom: none;
        }

        .conversation-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 15px;
            gap: 15px;
        }

        .conversation-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 10px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 8px;
        }

        .question {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
            line-height: 1.4;
            flex: 1;
        }

        .answer {
            color: #495057;
            line-height: 1.6;
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .session-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            white-space: nowrap;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .error-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .no-data-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .filter-chips {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .filter-chip {
            background: #e9ecef;
            color: #495057;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-chip:hover {
            background: #667eea;
            color: white;
        }

        .filter-chip.active {
            background: #667eea;
            color: white;
        }

        .debug-panel {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-size: 0.9em;
            display: none;
        }

        .debug-panel.show {
            display: block;
        }

        .debug-output {
            background: #263238;
            color: #4fc3f7;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .main-content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .controls-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .conversation-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .conversation-meta {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– CHEESEADE RAG ëŒ€ì‹œë³´ë“œ</h1>
            <p>ì‹¤ì‹œê°„ AI ëŒ€í™” ë¡œê·¸ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</p>
            <div class="status-badge">
                <div class="status-dot" id="statusDot"></div>
                <span id="connectionStatus">ì—°ê²° í™•ì¸ ì¤‘...</span>
            </div>
        </div>

        <div class="main-content">
            <!-- í†µê³„ ì„¹ì…˜ -->
            <div class="stats-section">
                <h2 class="section-title">ğŸ“Š ì‹¤ì‹œê°„ í†µê³„</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalConversations">-</div>
                        <div class="stat-label">ì´ ëŒ€í™” ìˆ˜</div>
                        <div class="stat-change stat-increase" id="conversationsChange" style="display: none;">
                            +5 (ì˜¤ëŠ˜)
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="uniqueSessions">-</div>
                        <div class="stat-label">ê³ ìœ  ì‚¬ìš©ì</div>
                        <div class="stat-change stat-increase" id="sessionsChange" style="display: none;">
                            +2 (ì˜¤ëŠ˜)
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgResponseTime">-</div>
                        <div class="stat-label">í‰ê·  ì‘ë‹µì‹œê°„ (ms)</div>
                        <div class="stat-change stat-decrease" id="responseTimeChange" style="display: none;">
                            -200ms (ê°œì„ )
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="popularModel">-</div>
                        <div class="stat-label">ì£¼ìš” AI ëª¨ë¸</div>
                        <div class="stat-change stat-increase" id="modelChange" style="display: none;">
                            RAG ëª¨ë¸ í™œì„±
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì»¨íŠ¸ë¡¤ ì„¹ì…˜ -->
            <div class="controls-section">
                <div class="controls-grid">
                    <div class="search-container">
                        <input type="text" id="searchInput" class="search-input" placeholder="ì§ˆë¬¸ ë‚´ìš©ì´ë‚˜ ë‹µë³€ìœ¼ë¡œ ê²€ìƒ‰...">
                        <div class="search-icon">ğŸ”</div>
                    </div>
                    <button class="btn btn-primary" onclick="searchConversations()">
                        ê²€ìƒ‰
                    </button>
                    <button class="btn btn-secondary" onclick="loadData()">
                        ğŸ”„ ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
                
                <div class="filter-chips">
                    <div class="filter-chip active" onclick="filterByPeriod('all')">ì „ì²´</div>
                    <div class="filter-chip" onclick="filterByPeriod('today')">ì˜¤ëŠ˜</div>
                    <div class="filter-chip" onclick="filterByPeriod('week')">ì´ë²ˆ ì£¼</div>
                    <div class="filter-chip" onclick="filterByModel('rag')">RAG ëª¨ë¸</div>
                    <div class="filter-chip" onclick="toggleDebug()">ğŸ”§ ë””ë²„ê·¸</div>
                </div>
            </div>

            <!-- ë””ë²„ê·¸ íŒ¨ë„ -->
            <div class="debug-panel" id="debugPanel">
                <h4>ğŸ”§ ë””ë²„ê·¸ ì •ë³´</h4>
                <button class="btn btn-secondary btn-small" onclick="testConnection()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                <button class="btn btn-secondary btn-small" onclick="clearDebugLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
                <div class="debug-output" id="debugOutput"></div>
            </div>

            <!-- ëŒ€í™” ëª©ë¡ ì„¹ì…˜ -->
            <div class="conversations-section">
                <div class="conversations-header">
                    <h2 class="section-title">ğŸ’¬ ìµœê·¼ ëŒ€í™” ê¸°ë¡</h2>
                </div>
                <div class="conversations-body">
                    <div id="conversationsList">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            ì‹œìŠ¤í…œ ì—°ê²° ë° ë°ì´í„° ë¡œë”© ì¤‘...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì„¤ì •
        const API_BASE = 'http://112.148.37.41:1889/api';
        let isOnline = false;
        let currentFilter = 'all';
        let allConversations = [];

        // ë””ë²„ê·¸ ë¡œê¹…
        function debugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const debugOutput = document.getElementById('debugOutput');
            
            console.log(`[${timestamp}] ${message}`, data || '');
            
            if (debugOutput) {
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `<span style="color: #81c784;">[${timestamp}]</span> ${message}`;
                if (data) {
                    logEntry.innerHTML += `<br><span style="color: #ffb74d;">${JSON.stringify(data, null, 2)}</span>`;
                }
                debugOutput.appendChild(logEntry);
                debugOutput.scrollTop = debugOutput.scrollHeight;
            }
        }

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(online, message = '') {
            isOnline = online;
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('connectionStatus');
            
            if (online) {
                statusDot.className = 'status-dot status-online';
                statusText.textContent = 'ğŸŸ¢ ì‹œìŠ¤í…œ ì •ìƒ ìš´ì˜';
            } else {
                statusDot.className = 'status-dot status-offline';
                statusText.textContent = `ğŸ”´ ì—°ê²° ì˜¤ë¥˜ ${message}`;
            }
        }

        // API ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testConnection() {
            debugLog('ğŸ”— ì‹œìŠ¤í…œ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            try {
                const response = await fetch(`${API_BASE}/../health`);
                const data = await response.json();
                
                if (response.ok) {
                    debugLog('âœ… ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ', data);
                    updateConnectionStatus(true);
                    return true;
                } else {
                    debugLog('âŒ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨', { status: response.status });
                    updateConnectionStatus(false, `(HTTP ${response.status})`);
                    return false;
                }
            } catch (error) {
                debugLog('ğŸ’¥ ì—°ê²° ì˜¤ë¥˜', error.message);
                updateConnectionStatus(false, '(ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜)');
                return false;
            }
        }

        // í†µê³„ ë°ì´í„° ë¡œë“œ
        async function loadStats() {
            try {
                debugLog('ğŸ“Š í†µê³„ ë°ì´í„° ë¡œë”©...');
                const response = await fetch(`${API_BASE}/stats`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const stats = await response.json();
                debugLog('ğŸ“ˆ í†µê³„ ë°ì´í„° ìˆ˜ì‹ ', stats);
                
                // í†µê³„ í‘œì‹œ
                document.getElementById('totalConversations').textContent = stats.total_conversations || 0;
                document.getElementById('uniqueSessions').textContent = stats.unique_sessions || 0;
                document.getElementById('avgResponseTime').textContent = Math.round(stats.avg_response_time || 0);
                
                const popularModel = stats.popular_models?.[0]?.model || 'N/A';
                document.getElementById('popularModel').textContent = 
                    popularModel.includes('rag') ? 'RAG ëª¨ë¸' : popularModel.split(':')[0];
                
                updateConnectionStatus(true);
                
            } catch (error) {
                debugLog('âŒ í†µê³„ ë¡œë”© ì‹¤íŒ¨', error.message);
                updateConnectionStatus(false, '(í†µê³„ API ì˜¤ë¥˜)');
                
                // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ê°’ í‘œì‹œ
                ['totalConversations', 'uniqueSessions', 'avgResponseTime', 'popularModel'].forEach(id => {
                    document.getElementById(id).textContent = 'ì˜¤ë¥˜';
                });
            }
        }

        // ëŒ€í™” ëª©ë¡ ë¡œë“œ
        async function loadConversations(query = '') {
            const listContainer = document.getElementById('conversationsList');
            
            listContainer.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    ${query ? 'ê²€ìƒ‰ ì¤‘...' : 'ëŒ€í™” ê¸°ë¡ ë¡œë”© ì¤‘...'}
                </div>
            `;
            
            try {
                debugLog(`ğŸ’¬ ëŒ€í™” ëª©ë¡ ë¡œë”©... ${query ? `ê²€ìƒ‰ì–´: "${query}"` : 'ì „ì²´ ëª©ë¡'}`);
                
                const url = query ? 
                    `${API_BASE}/search?q=${encodeURIComponent(query)}&limit=50` :
                    `${API_BASE}/conversations?limit=50`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const conversations = await response.json();
                allConversations = conversations;
                
                debugLog(`ğŸ“ ëŒ€í™” ë°ì´í„° ìˆ˜ì‹ : ${conversations.length}ê°œ`, conversations.slice(0, 2));
                
                displayConversations(conversations);
                updateConnectionStatus(true);
                
            } catch (error) {
                debugLog('ğŸ’¥ ëŒ€í™” ë¡œë”© ì‹¤íŒ¨', error.message);
                updateConnectionStatus(false, '(ëŒ€í™” API ì˜¤ë¥˜)');
                
                listContainer.innerHTML = `
                    <div class="error">
                        <div class="error-title">âŒ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</div>
                        <p>ì˜¤ë¥˜: ${error.message}</p>
                        <p>ê°€ëŠ¥í•œ ì›ì¸:</p>
                        <ul>
                            <li>ë¡œê¹… ì„œë²„ ì—°ê²° ë¬¸ì œ</li>
                            <li>ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜</li>
                            <li>CORS ì„¤ì • ë¬¸ì œ</li>
                        </ul>
                        <button class="btn btn-primary" onclick="loadData()" style="margin-top: 10px;">
                            ğŸ”„ ë‹¤ì‹œ ì‹œë„
                        </button>
                    </div>
                `;
            }
        }

        // ëŒ€í™” ëª©ë¡ í‘œì‹œ
        function displayConversations(conversations) {
            const listContainer = document.getElementById('conversationsList');
            
            if (!conversations || conversations.length === 0) {
                listContainer.innerHTML = `
                    <div class="no-data">
                        <div class="no-data-icon">ğŸ“­</div>
                        <h3>ì•„ì§ ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>RAG ì‹œìŠ¤í…œì„ ì‚¬ìš©í•´ì„œ AIì™€ ëŒ€í™”ë¥¼ ë‚˜ëˆ ë³´ì„¸ìš”!</p>
                        <button class="btn btn-primary" onclick="loadData()" style="margin-top: 15px;">
                            ğŸ”„ ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>
                `;
                return;
            }
            
            const conversationsHtml = conversations.map((conv, index) => {
                const question = conv.user_question || 'ì§ˆë¬¸ ì •ë³´ ì—†ìŒ';
                const answer = conv.rag_response || 'ì‘ë‹µ ì •ë³´ ì—†ìŒ';
                const responseTime = conv.response_time_ms || 0;
                const model = conv.model_used || 'ëª¨ë¸ ì •ë³´ ì—†ìŒ';
                const sessionId = conv.session_id || 'ì„¸ì…˜ ì •ë³´ ì—†ìŒ';
                const createdAt = conv.created_at || new Date().toISOString();
                const contextsCount = conv.contexts_count || 0;
                
                // ì‹œê°„ í¬ë§·íŒ…
                const timeAgo = getTimeAgo(createdAt);
                const fullTime = new Date(createdAt).toLocaleString('ko-KR');
                
                // ì‘ë‹µ ì‹œê°„ ìƒ‰ìƒ
                const responseTimeClass = responseTime < 3000 ? 'stat-increase' : 
                                        responseTime < 10000 ? 'stat-change' : 'stat-decrease';
                
                return `
                    <div class="conversation-item">
                        <div class="conversation-header">
                            <div class="question">
                                â“ ${highlightSearchTerm(question)}
                            </div>
                            <div class="session-badge">
                                ${sessionId.substring(0, 12)}...
                            </div>
                        </div>
                        
                        <div class="answer">
                            ğŸ¤– ${highlightSearchTerm(answer.substring(0, 300))}${answer.length > 300 ? '...' : ''}
                        </div>
                        
                        <div class="conversation-meta">
                            <div class="meta-item">
                                ğŸ“… <span title="${fullTime}">${timeAgo}</span>
                            </div>
                            <div class="meta-item">
                                âš¡ <span class="${responseTimeClass}">${responseTime}ms</span>
                            </div>
                            <div class="meta-item">
                                ğŸ¯ ${model.includes('rag') ? 'RAG ëª¨ë¸' : model}
                            </div>
                            <div class="meta-item">
                                ğŸ“„ ${contextsCount}ê°œ ë¬¸ì„œ ì°¸ì¡°
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            listContainer.innerHTML = conversationsHtml;
        }

        // ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŠ¸
        function highlightSearchTerm(text) {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) return text;
            
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<mark style="background: #ffeb3b; padding: 2px 4px; border-radius: 3px;">$1</mark>');
        }

        // ì‹œê°„ ê²½ê³¼ í‘œì‹œ
        function getTimeAgo(dateString) {
            const now = new Date();
            const past = new Date(dateString);
            const diffInSeconds = Math.floor((now - past) / 1000);
            
            if (diffInSeconds < 60) return 'ë°©ê¸ˆ ì „';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}ë¶„ ì „`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}ì‹œê°„ ì „`;
            if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}ì¼ ì „`;
            return `${Math.floor(diffInSeconds / 2592000)}ê°œì›” ì „`;
        }

        // ê²€ìƒ‰ ì‹¤í–‰
        function searchConversations() {
            const query = document.getElementById('searchInput').value.trim();
            debugLog(`ğŸ” ê²€ìƒ‰ ì‹¤í–‰: "${query}"`);
            loadConversations(query);
            updateFilterChips('search');
        }

        // ê¸°ê°„ë³„ í•„í„°ë§
        function filterByPeriod(period) {
            currentFilter = period;
            debugLog(`ğŸ“… ê¸°ê°„ í•„í„° ì ìš©: ${period}`);
            
            // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” APIì— ë‚ ì§œ íŒŒë¼ë¯¸í„° ì¶”ê°€
            loadConversations();
            updateFilterChips(period);
        }

        // ëª¨ë¸ë³„ í•„í„°ë§
        function filterByModel(model) {
            debugLog(`ğŸ¯ ëª¨ë¸ í•„í„° ì ìš©: ${model}`);
            
            if (model === 'rag') {
                const ragConversations = allConversations.filter(conv => 
                    conv.model_used && conv.model_used.includes('rag')
                );
                displayConversations(ragConversations);
            }
            updateFilterChips(model);
        }

        // í•„í„° ì¹© ì—…ë°ì´íŠ¸
        function updateFilterChips(activeFilter) {
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            
            const activeChip = [...document.querySelectorAll('.filter-chip')]
                .find(chip => chip.textContent.includes(activeFilter) || 
                            chip.onclick.toString().includes(activeFilter));
            
            if (activeChip) activeChip.classList.add('active');
        }

        // ë””ë²„ê·¸ íŒ¨ë„ í† ê¸€
        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            panel.classList.toggle('show');
            
            if (panel.classList.contains('show')) {
                debugLog('ğŸ”§ ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”');
            }
        }

        // ë””ë²„ê·¸ ë¡œê·¸ ì§€ìš°ê¸°
        function clearDebugLog() {
            const debugOutput = document.getElementById('debugOutput');
            debugOutput.innerHTML = '';
            debugLog('ğŸ§¹ ë””ë²„ê·¸ ë¡œê·¸ ì§€ì›Œì§');
        }

        // ì „ì²´ ë°ì´í„° ë¡œë“œ
        function loadData() {
            debugLog('ğŸš€ ì „ì²´ ì‹œìŠ¤í…œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹œì‘');
            loadStats();
            loadConversations();
        }

        // ì—”í„°í‚¤ ê²€ìƒ‰
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchConversations();
            }
        });

        // ê²€ìƒ‰ ì…ë ¥ ì‹¤ì‹œê°„ ì²˜ë¦¬
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            
            if (query.length === 0) {
                searchTimeout = setTimeout(() => {
                    loadConversations();
                }, 300);
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('ğŸŒŸ CHEESEADE RAG ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì‹œì‘');
            
            // ì—°ê²° í…ŒìŠ¤íŠ¸ í›„ ë°ì´í„° ë¡œë“œ
            testConnection().then(isConnected => {
                if (isConnected) {
                    loadData();
                } else {
                    debugLog('âš ï¸ ì´ˆê¸° ì—°ê²° ì‹¤íŒ¨, 5ì´ˆ í›„ ì¬ì‹œë„...');
                    setTimeout(() => {
                        testConnection().then(retry => {
                            if (retry) loadData();
                        });
                    }, 5000);
                }
            });
        });

        // ìë™ ìƒˆë¡œê³ ì¹¨ (30ì´ˆë§ˆë‹¤)
        setInterval(() => {
            if (isOnline && document.visibilityState === 'visible') {
                debugLog('ğŸ”„ ìë™ ìƒˆë¡œê³ ì¹¨ (30ì´ˆ ì£¼ê¸°)');
                loadStats(); // í†µê³„ë§Œ ìë™ ìƒˆë¡œê³ ì¹¨ (ëŒ€í™” ëª©ë¡ì€ ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ)
            }
        }, 30000);

        // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ ì²˜ë¦¬
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible' && isOnline) {
                debugLog('ğŸ‘ï¸ í˜ì´ì§€ ë‹¤ì‹œ í™œì„±í™”ë¨, ë°ì´í„° ìƒˆë¡œê³ ì¹¨');
                loadStats();
            }
        });

        // ìœˆë„ìš° í¬ì»¤ìŠ¤ ì‹œ ìƒˆë¡œê³ ì¹¨
        window.addEventListener('focus', function() {
            if (isOnline) {
                debugLog('ğŸ¯ ìœˆë„ìš° í¬ì»¤ìŠ¤ë¨, ìµœì‹  ë°ì´í„° í™•ì¸');
                loadStats();
            }
        });

        // ì˜¤ë¥˜ ì²˜ë¦¬
        window.addEventListener('error', function(e) {
            debugLog('ğŸ’¥ JavaScript ì˜¤ë¥˜ ë°œìƒ', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno
            });
        });

        // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ê°ì§€ (ì§€ì›ë˜ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ)
        if ('navigator' in window && 'onLine' in navigator) {
            window.addEventListener('online', function() {
                debugLog('ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë³µêµ¬ë¨');
                updateConnectionStatus(true, '(ë„¤íŠ¸ì›Œí¬ ë³µêµ¬)');
                loadData();
            });

            window.addEventListener('offline', function() {
                debugLog('ğŸ“¡ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠì–´ì§');
                updateConnectionStatus(false, '(ë„¤íŠ¸ì›Œí¬ ì˜¤í”„ë¼ì¸)');
            });
        }

        // ê°œë°œìë¥¼ ìœ„í•œ ì „ì—­ í•¨ìˆ˜ë“¤
        window.dashboardAPI = {
            testConnection,
            loadData,
            loadStats,
            loadConversations,
            debugLog,
            clearDebugLog,
            
            // ë°ì´í„° ì ‘ê·¼
            getAllConversations: () => allConversations,
            getConnectionStatus: () => isOnline,
            
            // ìœ í‹¸ë¦¬í‹°
            exportData: () => {
                const data = {
                    timestamp: new Date().toISOString(),
                    conversations: allConversations,
                    stats: {
                        total: document.getElementById('totalConversations').textContent,
                        sessions: document.getElementById('uniqueSessions').textContent,
                        avgTime: document.getElementById('avgResponseTime').textContent,
                        model: document.getElementById('popularModel').textContent
                    }
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rag_dashboard_export_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                debugLog('ğŸ“¥ ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
            }
        };

        // ê°œë°œì ì½˜ì†” ë©”ì‹œì§€
        console.log(`
ğŸ¤– CHEESEADE RAG ëŒ€ì‹œë³´ë“œ ë¡œë“œë¨!

ì‚¬ìš© ê°€ëŠ¥í•œ ê°œë°œì ëª…ë ¹ì–´:
â€¢ window.dashboardAPI.testConnection() - ì—°ê²° í…ŒìŠ¤íŠ¸
â€¢ window.dashboardAPI.loadData() - ë°ì´í„° ìƒˆë¡œê³ ì¹¨  
â€¢ window.dashboardAPI.exportData() - ë°ì´í„° ë‚´ë³´ë‚´ê¸°
â€¢ window.dashboardAPI.debugLog(message) - ë””ë²„ê·¸ ë¡œê·¸ ì¶”ê°€
â€¢ window.dashboardAPI.getAllConversations() - ëª¨ë“  ëŒ€í™” ë°ì´í„° ë°˜í™˜

ë””ë²„ê·¸ ëª¨ë“œ: ëŒ€ì‹œë³´ë“œì—ì„œ 'ğŸ”§ ë””ë²„ê·¸' ë²„íŠ¼ í´ë¦­
        `);
    </script>
</body>
</html>